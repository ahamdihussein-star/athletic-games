<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>üèÉ Athletic Games Pro üèÜ</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Press Start 2P', monospace; background: linear-gradient(135deg, #0f0f1a 0%, #1a1a3e 100%); min-height: 100vh; color: white; touch-action: manipulation; }
        .screen { display: none; min-height: 100vh; padding: 15px; flex-direction: column; align-items: center; }
        .screen.active { display: flex; }
        .title { font-size: 1rem; color: #f1c40f; text-shadow: 3px 3px 0 #e74c3c; text-align: center; margin: 15px 0; }
        .box { background: linear-gradient(180deg, #1a1a2e 0%, #0f0f1a 100%); border: 4px solid #f1c40f; padding: 20px; max-width: 400px; width: 100%; border-radius: 8px; }
        button, .opt, .color-opt { -webkit-appearance: none; cursor: pointer; transition: all 0.15s; }
        .btn { font-family: inherit; font-size: 0.5rem; padding: 12px; background: linear-gradient(180deg, #3498db 0%, #2980b9 100%); color: white; border: 3px solid #5dade2; width: 100%; margin: 5px 0; border-radius: 5px; }
        .btn:active { transform: scale(0.98); }
        .btn.red { background: linear-gradient(180deg, #e74c3c 0%, #c0392b 100%); border-color: #ec7063; }
        .btn.green { background: linear-gradient(180deg, #2ecc71 0%, #27ae60 100%); border-color: #58d68d; }
        .btn.gold { background: linear-gradient(180deg, #f1c40f 0%, #d4ac0d 100%); border-color: #f4d03f; color: black; }
        .btn.purple { background: linear-gradient(180deg, #9b59b6 0%, #8e44ad 100%); border-color: #bb8fce; }
        .btn:disabled { opacity: 0.4; }
        .input { font-family: inherit; font-size: 0.6rem; padding: 10px; background: #0a0a15; color: #f1c40f; border: 3px solid #f1c40f; width: 100%; text-align: center; border-radius: 5px; }
        .opts { display: flex; gap: 8px; flex-wrap: wrap; justify-content: center; margin: 10px 0; }
        .opt { padding: 8px 12px; background: #1a1a2e; border: 2px solid #555; font-family: inherit; font-size: 0.45rem; color: white; border-radius: 5px; }
        .opt.sel { border-color: #f1c40f; background: #2a2a4e; }
        .color-opt { width: 32px; height: 32px; border: 3px solid #555; border-radius: 50%; }
        .color-opt.sel { border-color: #f1c40f; transform: scale(1.1); }
        .games { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; max-width: 320px; margin-top: 15px; }
        .game-card { background: #1a1a2e; border: 3px solid #555; padding: 15px; text-align: center; border-radius: 8px; cursor: pointer; }
        .game-card:active { border-color: #f1c40f; }
        .game-card .icon { font-size: 1.8rem; }
        .game-card .name { font-size: 0.4rem; color: #f1c40f; margin-top: 8px; }
        #gameArea { width: 100%; max-width: 550px; }
        .hud { display: flex; justify-content: space-between; background: #1a1a2e; border: 3px solid #f1c40f; padding: 8px 12px; font-size: 0.45rem; margin-bottom: 5px; border-radius: 5px; }
        .hud .time { color: #2ecc71; font-size: 0.8rem; }
        #canvas { width: 100%; height: 280px; border: 4px solid #f1c40f; background: #1a1a2e; display: block; border-radius: 8px; }
        .ctrls { display: flex; gap: 12px; justify-content: center; margin-top: 12px; }
        .ctrl { font-family: inherit; font-size: 1.3rem; width: 75px; height: 75px; background: linear-gradient(180deg, #e74c3c 0%, #c0392b 100%); color: white; border: 4px solid #ec7063; border-radius: 10px; box-shadow: 0 4px 0 #922b21; }
        .ctrl:active { transform: translateY(4px); box-shadow: none; }
        .ctrl.blue { background: linear-gradient(180deg, #3498db 0%, #2980b9 100%); border-color: #5dade2; box-shadow: 0 4px 0 #1a5276; }
        .ctrl.green { background: linear-gradient(180deg, #2ecc71 0%, #27ae60 100%); border-color: #58d68d; box-shadow: 0 4px 0 #1e8449; }
        .info { font-size: 0.45rem; color: #888; text-align: center; margin: 8px 0; }
        .result { text-align: center; padding: 20px; }
        .result .icon { font-size: 3.5rem; margin-bottom: 15px; }
        .result .ttl { font-size: 0.8rem; color: #f1c40f; margin-bottom: 8px; }
        .result .score { font-size: 1.2rem; color: #2ecc71; margin-bottom: 15px; }
        .rank { display: flex; justify-content: space-between; padding: 8px; margin: 4px 0; background: #0a0a15; border: 2px solid #555; font-size: 0.45rem; border-radius: 5px; }
        .rank.gold { border-color: #f1c40f; }
        .rank.you { border-color: #3498db; background: rgba(52,152,219,0.2); }
        .back { position: absolute; top: 10px; left: 10px; font-family: inherit; font-size: 0.45rem; padding: 6px 10px; background: #333; color: white; border: 2px solid #555; border-radius: 5px; cursor: pointer; }
        .cd { position: fixed; inset: 0; background: rgba(0,0,0,0.95); display: none; align-items: center; justify-content: center; z-index: 100; flex-direction: column; }
        .cd.on { display: flex; }
        .cd .num { font-size: 5rem; color: #f1c40f; }
        .cd .txt { font-size: 0.7rem; color: #fff; margin-top: 15px; }
        .room-code { font-size: 1.3rem; color: #f1c40f; background: #0a0a15; padding: 12px 25px; border: 3px solid #f1c40f; border-radius: 8px; letter-spacing: 6px; margin: 15px 0; }
        .player-item { display: flex; justify-content: space-between; padding: 8px 12px; background: #1a1a2e; border: 2px solid #555; margin: 4px 0; border-radius: 5px; font-size: 0.5rem; }
        .player-item.host { border-color: #f1c40f; }
        .stitle { font-size: 0.5rem; color: #f1c40f; margin: 12px 0 8px; text-align: center; }
        .live { position: absolute; top: 5px; right: 5px; background: rgba(0,0,0,0.8); padding: 6px; border-radius: 5px; font-size: 0.35rem; }
        .live div { display: flex; justify-content: space-between; gap: 8px; padding: 2px 0; }
        .live .you { color: #3498db; font-weight: bold; }
    </style>
</head>
<body>
<div class="cd" id="cdBox"><div class="num" id="cdNum">3</div><div class="txt" id="cdTxt">GET READY!</div></div>

<!-- REGISTER -->
<div class="screen active" id="s1">
    <h1 class="title">üèÉ ATHLETIC<br>GAMES PRO üèÜ</h1>
    <div class="box">
        <p class="stitle">PLAYER NAME</p>
        <input class="input" id="inpName" placeholder="YOUR NAME" maxlength="10">
        <p class="stitle">GENDER</p>
        <div class="opts" id="genderOpts"></div>
        <p class="stitle">SKIN COLOR</p>
        <div class="opts" id="skinColors"></div>
        <button class="btn gold" id="btnReg" style="margin-top:15px;">‚ñ∂ START</button>
    </div>
</div>

<!-- MENU -->
<div class="screen" id="s2">
    <h1 class="title">üèÉ ATHLETIC<br>GAMES PRO üèÜ</h1>
    <div style="display:flex;align-items:center;gap:12px;margin-bottom:20px;">
        <canvas id="menuAv" width="55" height="55" style="border:3px solid #f1c40f;border-radius:8px;"></canvas>
        <div><div id="mName" style="color:#f1c40f;font-size:0.65rem;">PLAYER</div><div style="color:#666;font-size:0.35rem;margin-top:4px;">READY TO RACE</div></div>
    </div>
    <div style="display:flex;flex-direction:column;gap:8px;width:100%;max-width:260px;">
        <button class="btn red" id="btnQuick">üéÆ QUICK RACE</button>
        <button class="btn purple" id="btnOnline">üåê ONLINE</button>
        <button class="btn green" id="btnTourn">üèÜ TOURNAMENT</button>
        <button class="btn" id="btnLB">üìä RECORDS</button>
    </div>
</div>

<!-- SELECT GAME -->
<div class="screen" id="s3">
    <button class="back" id="backS3">‚Üê BACK</button>
    <p style="font-size:0.7rem;color:#f1c40f;margin-top:40px;">SELECT EVENT</p>
    <div class="games" id="gamesList"></div>
</div>

<!-- SELECT DISTANCE -->
<div class="screen" id="sDist">
    <button class="back" id="backDist">‚Üê BACK</button>
    <p style="font-size:0.7rem;color:#f1c40f;margin-top:40px;" id="distTitle">OPTIONS</p>
    <div class="box" style="margin-top:15px;text-align:center;">
        <p class="stitle">DISTANCE</p>
        <div class="opts" id="distOpts"></div>
        <p class="stitle">DIFFICULTY</p>
        <div class="opts" id="diffOpts"></div>
        <p class="stitle">OUTFIT COLOR</p>
        <div class="opts" id="outfitColors"></div>
        <button class="btn gold" id="btnStart" style="margin-top:15px;">‚ñ∂ START RACE</button>
    </div>
</div>

<!-- ONLINE -->
<div class="screen" id="sOnline">
    <button class="back" id="backOnline">‚Üê BACK</button>
    <p style="font-size:0.7rem;color:#f1c40f;margin-top:40px;">üåê ONLINE</p>
    <div class="box" style="margin-top:15px;text-align:center;">
        <button class="btn green" id="btnHost">üè† CREATE ROOM</button>
        <p style="color:#666;font-size:0.35rem;margin:12px 0;">- OR -</p>
        <input class="input" id="inpRoom" placeholder="ROOM CODE" maxlength="6" style="text-transform:uppercase;">
        <button class="btn purple" id="btnJoin" style="margin-top:8px;">üö™ JOIN</button>
    </div>
    <p id="onlineStatus" style="color:#888;font-size:0.4rem;margin-top:12px;"></p>
</div>

<!-- ROOM -->
<div class="screen" id="sRoom">
    <button class="back" id="backRoom">‚Üê LEAVE</button>
    <p style="font-size:0.7rem;color:#f1c40f;margin-top:40px;">GAME ROOM</p>
    <div class="room-code" id="roomCode">XXXX</div>
    <p style="font-size:0.35rem;color:#666;margin-bottom:12px;">Share code with friends!</p>
    <div id="roomPlayers" style="width:100%;max-width:280px;"></div>
    <div id="hostCtrl" style="display:none;width:100%;max-width:280px;margin-top:12px;">
        <p class="stitle">DISTANCE</p>
        <div class="opts" id="roomDist"></div>
        <button class="btn gold" id="btnStartOnline" disabled>‚ñ∂ START</button>
    </div>
    <p id="guestWait" style="display:none;color:#666;font-size:0.4rem;margin-top:15px;">Waiting for host...</p>
</div>

<!-- GAME -->
<div class="screen" id="s6">
    <div id="gameArea">
        <div class="hud"><span id="hEvent">100M</span><span id="hDist" style="color:#f1c40f;">0/100m</span><span class="time" id="hTime">00:00.00</span></div>
        <div style="position:relative;">
            <canvas id="canvas" width="550" height="280"></canvas>
            <div class="live" id="livePos"></div>
        </div>
        <p class="info" id="hInfo">TAP ‚óÄ ‚ñ∂ ALTERNATELY!</p>
        <div class="ctrls" id="ctrls"></div>
    </div>
</div>

<!-- RESULT -->
<div class="screen" id="s7">
    <div class="box result">
        <div class="icon" id="rIcon">üèÜ</div>
        <div class="ttl" id="rTtl">FINISH!</div>
        <div class="score" id="rScore">9.85s</div>
        <div id="rRanks"></div>
        <div style="display:flex;gap:8px;margin-top:15px;justify-content:center;">
            <button class="btn red" id="btnRetry">üîÑ RETRY</button>
            <button class="btn" id="btnCont">MENU</button>
        </div>
    </div>
</div>

<!-- LEADERBOARD -->
<div class="screen" id="s8">
    <button class="back" id="backS8">‚Üê BACK</button>
    <p style="font-size:0.7rem;color:#f1c40f;margin-top:40px;">üìä RECORDS</p>
    <div class="opts" id="lbDist" style="margin:12px 0;"></div>
    <div id="lbList" style="width:100%;max-width:350px;"></div>
</div>

<!-- TOURNAMENT -->
<div class="screen" id="s5">
    <button class="back" id="backS5">‚Üê EXIT</button>
    <p style="font-size:0.7rem;color:#f1c40f;margin-top:40px;">üèÜ TOURNAMENT</p>
    <div class="box" style="margin-top:15px;text-align:center;">
        <p style="font-size:0.35rem;color:#666;margin-bottom:10px;">Complete all events!</p>
        <div id="tList"></div>
    </div>
    <button class="btn gold" id="btnNextE" style="margin-top:12px;max-width:260px;">‚ñ∂ NEXT</button>
</div>

<script>
const DISTS = [{m:50,t:6},{m:100,t:10},{m:200,t:20},{m:400,t:45},{m:800,t:110},{m:1500,t:210}];
const DIFFS = [{id:'easy',n:'EASY',s:0.7,c:'#2ecc71'},{id:'medium',n:'MEDIUM',s:0.85,c:'#f1c40f'},{id:'hard',n:'HARD',s:1.0,c:'#e74c3c'},{id:'extreme',n:'EXTREME',s:1.15,c:'#9b59b6'}];
const GAMES = {sprint:{n:'SPRINT',icon:'üèÉ'},swim:{n:'SWIM',icon:'üèä'},hurdles:{n:'HURDLES',icon:'üöß'}};
const SKINS = ['#ffdbac','#f1c27d','#e0ac69','#c68642','#8d5524','#5c3a21'];
const OUTFITS = ['#3498db','#e74c3c','#2ecc71','#9b59b6','#f39c12','#1abc9c','#e91e63','#000'];
const TEVENTS = [{g:'sprint',d:100},{g:'sprint',d:200},{g:'swim',d:100},{g:'hurdles',d:100},{g:'sprint',d:400},{g:'sprint',d:1500}];

let player = {name:'PLAYER',gender:'male',skin:'#ffdbac',outfit:'#3498db'};
let curGame='sprint',curDist=100,curDiff='medium';
let isTourn=false,tIdx=0,tScores={};
let isOnline=false,isHost=false,peer=null,conns=[],roomCode='';
let onlinePlayers=[];

let canvas,ctx,W=550,H=280;
let running=false,startT=0;
let playerPos=0,playerSpeed=0,lastK='R',jumpY=0;
let cpus=[],hurdles=[],anim;

const save=(k,v)=>localStorage.setItem('agp_'+k,JSON.stringify(v));
const load=k=>{try{return JSON.parse(localStorage.getItem('agp_'+k));}catch{return null;}};
function saveScore(d,t){let a=load('sc_'+curGame+'_'+d)||[];a.push({n:player.name,t,d:Date.now()});a.sort((x,y)=>x.t-y.t);save('sc_'+curGame+'_'+d,a.slice(0,20));}

function tap(el,fn){if(!el)return;let m=false;el.addEventListener('touchstart',()=>m=false,{passive:true});el.addEventListener('touchmove',()=>m=true,{passive:true});el.addEventListener('touchend',e=>{if(!m){e.preventDefault();fn(e);}},{passive:false});el.addEventListener('click',fn);}
function show(id){document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));document.getElementById(id).classList.add('active');}

document.addEventListener('DOMContentLoaded',()=>{
    // Gender
    const gDiv=document.getElementById('genderOpts');
    [['male','üë® MALE'],['female','üë© FEMALE']].forEach(([g,t],i)=>{const d=document.createElement('div');d.className='opt'+(i===0?' sel':'');d.textContent=t;tap(d,()=>{document.querySelectorAll('#genderOpts .opt').forEach(x=>x.classList.remove('sel'));d.classList.add('sel');player.gender=g;});gDiv.appendChild(d);});
    
    // Skin
    const sDiv=document.getElementById('skinColors');
    SKINS.forEach((c,i)=>{const d=document.createElement('div');d.className='color-opt'+(i===0?' sel':'');d.style.background=c;tap(d,()=>{document.querySelectorAll('#skinColors .color-opt').forEach(x=>x.classList.remove('sel'));d.classList.add('sel');player.skin=c;});sDiv.appendChild(d);});
    
    // Games
    const gameDiv=document.getElementById('gamesList');
    Object.entries(GAMES).forEach(([k,v])=>{const d=document.createElement('div');d.className='game-card';d.innerHTML=`<div class="icon">${v.icon}</div><div class="name">${v.n}</div>`;tap(d,()=>showDist(k));gameDiv.appendChild(d);});
    
    // Buttons
    tap(document.getElementById('btnReg'),register);
    tap(document.getElementById('btnQuick'),()=>show('s3'));
    tap(document.getElementById('btnOnline'),()=>show('sOnline'));
    tap(document.getElementById('btnTourn'),startTourn);
    tap(document.getElementById('btnLB'),()=>{showLB(100);show('s8');});
    tap(document.getElementById('backS3'),()=>show('s2'));
    tap(document.getElementById('backDist'),()=>show('s3'));
    tap(document.getElementById('backOnline'),()=>show('s2'));
    tap(document.getElementById('backRoom'),leaveRoom);
    tap(document.getElementById('backS5'),()=>{isTourn=false;show('s2');});
    tap(document.getElementById('backS8'),()=>show('s2'));
    tap(document.getElementById('btnStart'),startRace);
    tap(document.getElementById('btnRetry'),retry);
    tap(document.getElementById('btnCont'),()=>show('s2'));
    tap(document.getElementById('btnNextE'),nextTourn);
    tap(document.getElementById('btnHost'),createRoom);
    tap(document.getElementById('btnJoin'),joinRoom);
    tap(document.getElementById('btnStartOnline'),startOnline);
});

function register(){player.name=document.getElementById('inpName').value.trim().toUpperCase()||'PLAYER';document.getElementById('mName').textContent=player.name;drawMenuAv();show('s2');}

function drawMenuAv(){const c=document.getElementById('menuAv'),x=c.getContext('2d');x.fillStyle='#0a0a15';x.fillRect(0,0,55,55);drawChar(x,27,32,player.skin,player.outfit,player.gender==='female',1,0);}

function showDist(g){
    curGame=g;document.getElementById('distTitle').textContent=GAMES[g].n+' OPTIONS';
    const dDiv=document.getElementById('distOpts');dDiv.innerHTML='';
    const avail=g==='swim'?DISTS.slice(0,4):DISTS;
    avail.forEach(d=>{const el=document.createElement('div');el.className='opt'+(d.m===100?' sel':'');el.textContent=d.m+'M';tap(el,()=>{document.querySelectorAll('#distOpts .opt').forEach(x=>x.classList.remove('sel'));el.classList.add('sel');curDist=d.m;});dDiv.appendChild(el);});
    curDist=100;
    
    const diffDiv=document.getElementById('diffOpts');diffDiv.innerHTML='';
    DIFFS.forEach(d=>{const el=document.createElement('div');el.className='opt'+(d.id==='medium'?' sel':'');el.textContent=d.n;el.style.color=d.c;tap(el,()=>{document.querySelectorAll('#diffOpts .opt').forEach(x=>x.classList.remove('sel'));el.classList.add('sel');curDiff=d.id;});diffDiv.appendChild(el);});
    curDiff='medium';
    
    const oDiv=document.getElementById('outfitColors');oDiv.innerHTML='';
    OUTFITS.forEach(c=>{const el=document.createElement('div');el.className='color-opt'+(c===player.outfit?' sel':'');el.style.background=c;tap(el,()=>{document.querySelectorAll('#outfitColors .color-opt').forEach(x=>x.classList.remove('sel'));el.classList.add('sel');player.outfit=c;});oDiv.appendChild(el);});
    
    show('sDist');
}

// ONLINE
function genCode(){return Math.random().toString(36).substring(2,6).toUpperCase();}

function createRoom(){
    roomCode=genCode();document.getElementById('onlineStatus').textContent='Creating...';
    peer=new Peer('ath-'+roomCode);
    peer.on('open',()=>{isHost=true;isOnline=true;onlinePlayers=[{id:'host',name:player.name}];document.getElementById('roomCode').textContent=roomCode;updateRoomUI();show('sRoom');});
    peer.on('connection',conn=>{conn.on('data',data=>handleData(conn,data));conn.on('close',()=>removePlayer(conn.peer));conns.push(conn);});
    peer.on('error',err=>{document.getElementById('onlineStatus').textContent='Error: '+err.type;});
}

function joinRoom(){
    roomCode=document.getElementById('inpRoom').value.trim().toUpperCase();
    if(roomCode.length<4){document.getElementById('onlineStatus').textContent='Enter valid code';return;}
    document.getElementById('onlineStatus').textContent='Connecting...';
    peer=new Peer();
    peer.on('open',()=>{const conn=peer.connect('ath-'+roomCode);conn.on('open',()=>{isHost=false;isOnline=true;conns=[conn];conn.send({type:'join',name:player.name});});conn.on('data',data=>handleData(conn,data));conn.on('error',()=>{document.getElementById('onlineStatus').textContent='Room not found';});});
}

function handleData(conn,data){
    if(data.type==='join'){onlinePlayers.push({id:conn.peer,name:data.name});broadcast();updateRoomUI();}
    else if(data.type==='players'){onlinePlayers=data.players;updateRoomUI();show('sRoom');}
    else if(data.type==='start'){curGame=data.g;curDist=data.d;curDiff='hard';startRace();}
    else if(data.type==='pos'){}
    else if(data.type==='finish'){}
}

function broadcast(){conns.forEach(c=>c.send({type:'players',players:onlinePlayers}));}

function updateRoomUI(){
    document.getElementById('roomCode').textContent=roomCode;
    document.getElementById('roomPlayers').innerHTML=onlinePlayers.map((p,i)=>`<div class="player-item ${i===0?'host':''}"><span>${i===0?'üëë ':''}${p.name}</span><span>‚úÖ</span></div>`).join('');
    document.getElementById('hostCtrl').style.display=isHost?'block':'none';
    document.getElementById('guestWait').style.display=isHost?'none':'block';
    document.getElementById('btnStartOnline').disabled=onlinePlayers.length<2;
    
    if(isHost){const rd=document.getElementById('roomDist');rd.innerHTML='';DISTS.slice(0,4).forEach(d=>{const el=document.createElement('div');el.className='opt'+(d.m===100?' sel':'');el.textContent=d.m+'M';tap(el,()=>{document.querySelectorAll('#roomDist .opt').forEach(x=>x.classList.remove('sel'));el.classList.add('sel');curDist=d.m;});rd.appendChild(el);});}
}

function removePlayer(id){onlinePlayers=onlinePlayers.filter(p=>p.id!==id);conns=conns.filter(c=>c.peer!==id);updateRoomUI();}
function leaveRoom(){if(peer)peer.destroy();peer=null;conns=[];isOnline=false;isHost=false;show('s2');}
function startOnline(){curGame='sprint';conns.forEach(c=>c.send({type:'start',g:curGame,d:curDist}));startRace();}

// TOURNAMENT
function startTourn(){isTourn=true;tIdx=0;tScores={};updateTournUI();show('s5');}
function updateTournUI(){document.getElementById('tList').innerHTML=TEVENTS.map((e,i)=>{const info=GAMES[e.g];const sc=tScores[i];const done=i<tIdx,cur=i===tIdx;return`<div style="display:flex;justify-content:space-between;padding:6px;border-bottom:1px solid #333;color:${done?'#2ecc71':cur?'#f1c40f':'#555'}"><span>${done?'‚úì ':cur?'‚Üí ':''}${info.icon} ${e.d}M</span><span style="color:#f1c40f">${sc!==undefined?sc.toFixed(2)+'s':'-'}</span></div>`;}).join('');document.getElementById('btnNextE').textContent=tIdx>=TEVENTS.length?'üèÜ RESULTS':'‚ñ∂ NEXT';}
function nextTourn(){if(tIdx>=TEVENTS.length){showTournRes();return;}const ev=TEVENTS[tIdx];curGame=ev.g;curDist=ev.d;curDiff='hard';startRace();}
function showTournRes(){const tot=Object.values(tScores).reduce((a,b)=>a+b,0);document.getElementById('rIcon').textContent='üèÜ';document.getElementById('rTtl').textContent='TOURNAMENT!';document.getElementById('rScore').textContent=tot.toFixed(2)+'s TOTAL';document.getElementById('rRanks').innerHTML=TEVENTS.map((e,i)=>`<div class="rank"><span>${GAMES[e.g].icon} ${e.d}M</span><span>${tScores[i]?.toFixed(2)||'-'}s</span></div>`).join('');isTourn=false;show('s7');}

// START RACE
function startRace(){
    const dInfo=DISTS.find(d=>d.m===curDist);
    document.getElementById('hEvent').textContent=curDist+'M '+GAMES[curGame].n;
    
    running=false;playerPos=0;playerSpeed=0;lastK='R';jumpY=0;
    
    const diff=DIFFS.find(d=>d.id===curDiff);
    const baseSpd=curDist/dInfo.t;
    
    cpus=[];
    const cols=['#e74c3c','#9b59b6','#1abc9c','#e67e22','#95a5a6'];
    const sks=['#ffdbac','#c68642','#8d5524','#f1c27d','#e0ac69'];
    const names=['BOLT','LEWIS','OWENS','FRASER','FELIX'];
    for(let i=0;i<5;i++){cpus.push({pos:0,spd:baseSpd*diff.s*(0.92+Math.random()*0.16),col:cols[i],skin:sks[i],fem:Math.random()>0.5,name:names[i],fin:false,time:0});}
    
    if(curGame==='hurdles'){hurdles=[];const hc=Math.floor(curDist/20);for(let i=0;i<hc;i++)hurdles.push({x:(i+1)*(curDist/(hc+1)),hit:false});}
    
    setupCtrls();show('s6');
    
    setTimeout(()=>{canvas=document.getElementById('canvas');canvas.width=550;canvas.height=280;W=550;H=280;ctx=canvas.getContext('2d');drawFrame(0);countdown(()=>{startT=Date.now();running=true;loop();});},100);
}

function setupCtrls(){
    const div=document.getElementById('ctrls');div.innerHTML='';
    document.getElementById('hInfo').textContent=curGame==='hurdles'?'TAP ‚óÄ ‚ñ∂ TO RUN, ‚¨Ü TO JUMP!':'TAP ‚óÄ ‚ñ∂ ALTERNATELY AS FAST AS YOU CAN!';
    addCtrl(div,'‚óÄ','blue',()=>doTap('L'));
    addCtrl(div,'‚ñ∂','green',()=>doTap('R'));
    if(curGame==='hurdles')addCtrl(div,'‚¨Ü','',doJump);
}

function addCtrl(p,t,c,fn){const b=document.createElement('button');b.className='ctrl'+(c?' '+c:'');b.textContent=t;tap(b,fn);p.appendChild(b);}

function doTap(s){if(!running)return;playerSpeed+=s!==lastK?0.9:0.35;lastK=s;}
function doJump(){if(running&&jumpY===0)jumpY=1;}

function countdown(cb){
    const ov=document.getElementById('cdBox'),num=document.getElementById('cdNum'),txt=document.getElementById('cdTxt');
    ov.classList.add('on');let c=3;num.textContent=c;txt.textContent='GET READY!';
    const rd=setInterval(()=>drawFrame(0),60);
    const iv=setInterval(()=>{c--;if(c>0){num.textContent=c;txt.textContent=c===1?'SET...':'GET READY!';}else if(c===0){num.textContent='GO!';txt.textContent='';}else{clearInterval(iv);clearInterval(rd);ov.classList.remove('on');cb();}},800);
}

function loop(){
    if(!running)return;
    const t=(Date.now()-startT)/1000;
    document.getElementById('hTime').textContent=fmtTime(t);
    document.getElementById('hDist').textContent=playerPos.toFixed(1)+'/'+curDist+'m';
    
    playerPos+=playerSpeed*0.16;playerSpeed*=0.93;
    
    if(jumpY>0){jumpY+=0.9;if(jumpY>15)jumpY=-15;}else if(jumpY<0){jumpY+=0.9;if(jumpY>0)jumpY=0;}
    
    if(curGame==='hurdles'){const jOff=jumpY>0?-jumpY*3:jumpY*3;hurdles.forEach(h=>{if(!h.hit&&Math.abs(playerPos-h.x)<3){if(jOff>-20)playerSpeed*=0.2;h.hit=true;}});}
    
    cpus.forEach(cpu=>{if(!cpu.fin){cpu.pos+=cpu.spd*(0.095+Math.random()*0.015);if(cpu.pos>=curDist){cpu.fin=true;cpu.time=t;}}});
    
    updateLive(t);drawFrame(t);
    
    if(playerPos>=curDist){endRace(t);return;}
    anim=requestAnimationFrame(loop);
}

function updateLive(t){
    const all=[{name:'YOU',pos:playerPos,you:true},...cpus.map(c=>({name:c.name,pos:c.pos,you:false}))].sort((a,b)=>b.pos-a.pos);
    document.getElementById('livePos').innerHTML=all.slice(0,4).map((r,i)=>`<div class="${r.you?'you':''}"><span>${i+1}.</span><span>${r.name}</span><span>${r.pos.toFixed(1)}m</span></div>`).join('');
}

function fmtTime(s){const m=Math.floor(s/60),sec=Math.floor(s%60),ms=Math.floor((s%1)*100);return`${String(m).padStart(2,'0')}:${String(sec).padStart(2,'0')}.${String(ms).padStart(2,'0')}`;}

function drawFrame(t){ctx.fillStyle='#0a0a15';ctx.fillRect(0,0,W,H);if(curGame==='swim')drawSwim(t);else drawTrack(t);}

function drawTrack(t){
    const tY=H*0.32,lH=38,lanes=6;
    // Sky
    const sky=ctx.createLinearGradient(0,0,0,tY);sky.addColorStop(0,'#1a3a5c');sky.addColorStop(1,'#2d6a9f');ctx.fillStyle=sky;ctx.fillRect(0,0,W,tY);
    // Stadium
    ctx.fillStyle='#2c3e50';ctx.fillRect(0,tY-45,W,45);
    // Audience
    const cols=['#e74c3c','#f39c12','#3498db','#9b59b6','#2ecc71'];
    for(let r=0;r<3;r++)for(let i=0;i<W/10;i++){const b=Math.sin(t*6+i*0.4+r)*2;ctx.fillStyle=cols[(i+r)%5];ctx.beginPath();ctx.arc(i*10+5,tY-32+r*14+b,4,0,Math.PI*2);ctx.fill();}
    // Track
    ctx.fillStyle='#c0392b';ctx.fillRect(0,tY,W,lH*lanes);
    // Lanes
    ctx.strokeStyle='rgba(255,255,255,0.4)';ctx.lineWidth=2;for(let i=0;i<=lanes;i++){ctx.beginPath();ctx.moveTo(0,tY+i*lH);ctx.lineTo(W,tY+i*lH);ctx.stroke();}
    
    const visDist=55,camOff=Math.max(0,playerPos-18);
    // Markers
    ctx.fillStyle='white';ctx.font='9px monospace';
    for(let m=0;m<=curDist;m+=curDist>200?50:10){const sx=((m-camOff)/visDist)*W;if(sx>=0&&sx<=W){ctx.fillStyle='rgba(255,255,255,0.25)';ctx.fillRect(sx,tY,2,lH*lanes);ctx.fillStyle='white';ctx.fillText(m+'m',sx+3,tY+10);}}
    // Finish
    const fsx=((curDist-camOff)/visDist)*W;if(fsx>=0&&fsx<=W){for(let r=0;r<lanes;r++)for(let c=0;c<3;c++){ctx.fillStyle=(r+c)%2?'black':'white';ctx.fillRect(fsx+c*7,tY+r*lH,7,lH);}}
    // Hurdles
    if(curGame==='hurdles')hurdles.forEach(h=>{const hx=((h.x-camOff)/visDist)*W;if(hx>=-20&&hx<=W+20){ctx.fillStyle=h.hit?'#27ae60':'#f39c12';ctx.fillRect(hx-2,tY+lH-22,4,22);ctx.fillRect(hx+18,tY+lH-22,4,22);ctx.fillStyle=h.hit?'#2ecc71':'#e74c3c';ctx.fillRect(hx-3,tY+lH-25,25,5);}});
    // CPUs
    cpus.forEach((cpu,i)=>{const cx=((cpu.pos-camOff)/visDist)*W;if(cx>=-30&&cx<=W+30){const ly=tY+(i+1)*lH+lH/2;drawChar(ctx,cx,ly,cpu.skin,cpu.col,cpu.fem,1.4,t);}});
    // Player
    const px=((playerPos-camOff)/visDist)*W,jOff=jumpY>0?-jumpY*3:jumpY*3,pY=tY+lH/2+jOff;
    drawChar(ctx,px,pY,player.skin,player.outfit,player.gender==='female',1.4,t);
    // Indicator
    ctx.fillStyle='#f1c40f';ctx.beginPath();ctx.moveTo(px,pY-42);ctx.lineTo(px-7,pY-52);ctx.lineTo(px+7,pY-52);ctx.fill();ctx.font='bold 9px monospace';ctx.fillText('YOU',px-11,pY-56);
}

function drawSwim(t){
    const lH=H/6;
    // Water
    const w=ctx.createLinearGradient(0,0,0,H);w.addColorStop(0,'#1a5276');w.addColorStop(0.5,'#2e86c1');w.addColorStop(1,'#1a5276');ctx.fillStyle=w;ctx.fillRect(0,0,W,H);
    // Ripples
    ctx.strokeStyle='rgba(255,255,255,0.1)';ctx.lineWidth=2;for(let i=0;i<8;i++){const y=(t*25+i*35)%H;ctx.beginPath();ctx.moveTo(0,y);for(let x=0;x<W;x+=20)ctx.lineTo(x+10,y+Math.sin(x*0.05+t*3)*5);ctx.stroke();}
    // Lanes
    for(let i=0;i<=6;i++){const cols=['#e74c3c','#f1c40f'];for(let j=0;j<W;j+=14){ctx.fillStyle=cols[Math.floor(j/14)%2];ctx.beginPath();ctx.arc(j+7,i*lH,3,0,Math.PI*2);ctx.fill();}}
    // Walls
    ctx.fillStyle='#7f8c8d';ctx.fillRect(0,0,22,H);ctx.fillRect(W-22,0,22,H);ctx.fillStyle='#f1c40f';ctx.fillRect(W-25,0,4,H);
    
    const visDist=45,camOff=Math.max(0,playerPos-12);
    // Markers
    ctx.fillStyle='rgba(255,255,255,0.4)';ctx.font='9px monospace';for(let m=0;m<=curDist;m+=25){const sx=22+((m-camOff)/visDist)*(W-44);if(sx>=22&&sx<=W-22){ctx.fillRect(sx,0,2,H);ctx.fillText(m+'m',sx+4,18);}}
    // CPUs
    cpus.forEach((cpu,i)=>{const cx=22+((cpu.pos-camOff)/visDist)*(W-44);if(cx>=0&&cx<=W){const ly=(i+1)*lH+lH/2;drawSwimmer(ctx,cx,ly,cpu.skin,cpu.col,t);}});
    // Player
    const px=22+((playerPos-camOff)/visDist)*(W-44);drawSwimmer(ctx,px,lH/2,player.skin,player.outfit,t);
    ctx.fillStyle='#f1c40f';ctx.font='bold 9px monospace';ctx.fillText('YOU ‚ñº',px-14,lH/2-22);
}

function drawChar(ctx,x,y,skin,outfit,fem,s,t){
    ctx.save();ctx.translate(x,y);
    // Shadow
    ctx.fillStyle='rgba(0,0,0,0.3)';ctx.beginPath();ctx.ellipse(0,10*s,9*s,3*s,0,0,Math.PI*2);ctx.fill();
    const legA=Math.sin(t*22)*10;
    // Legs
    ctx.fillStyle=skin;
    ctx.save();ctx.translate(-3*s,0);ctx.rotate((-20-legA)*Math.PI/180);ctx.fillRect(-2.5*s,0,5*s,16*s);ctx.fillStyle='#2c3e50';ctx.fillRect(-3*s,13*s,6*s,4*s);ctx.restore();
    ctx.fillStyle=skin;ctx.save();ctx.translate(3*s,0);ctx.rotate((20+legA)*Math.PI/180);ctx.fillRect(-2.5*s,0,5*s,16*s);ctx.fillStyle='#2c3e50';ctx.fillRect(-3*s,13*s,6*s,4*s);ctx.restore();
    // Shorts
    ctx.fillStyle=outfit;ctx.fillRect(-7*s,-4*s,14*s,10*s);
    // Body
    ctx.fillStyle=outfit;ctx.fillRect(-8*s,-22*s,16*s,19*s);
    ctx.fillStyle='rgba(255,255,255,0.2)';ctx.fillRect(-1.5*s,-20*s,3*s,15*s);
    // Arms
    const armA=Math.sin(t*22+Math.PI)*12;ctx.fillStyle=skin;
    ctx.save();ctx.translate(-9*s,-18*s);ctx.rotate((25-armA)*Math.PI/180);ctx.fillRect(-2*s,0,4*s,12*s);ctx.restore();
    ctx.save();ctx.translate(9*s,-18*s);ctx.rotate((-25+armA)*Math.PI/180);ctx.fillRect(-2*s,0,4*s,12*s);ctx.restore();
    // Head
    ctx.fillStyle=skin;ctx.beginPath();ctx.arc(0,-29*s,8*s,0,Math.PI*2);ctx.fill();
    // Hair
    ctx.fillStyle=fem?'#5D4037':'#2c3e50';
    if(fem){ctx.beginPath();ctx.arc(0,-32*s,8*s,Math.PI,0);ctx.fill();ctx.beginPath();ctx.ellipse(7*s,-29*s,3*s,7*s,0.3,0,Math.PI*2);ctx.fill();}else{ctx.beginPath();ctx.arc(0,-33*s,7*s,Math.PI*0.8,Math.PI*0.2);ctx.fill();}
    // Eyes
    ctx.fillStyle='#000';ctx.fillRect(-3.5*s,-31*s,2*s,2.5*s);ctx.fillRect(1.5*s,-31*s,2*s,2.5*s);
    ctx.restore();
}

function drawSwimmer(ctx,x,y,skin,outfit,t){
    ctx.save();ctx.translate(x,y);
    // Body
    ctx.fillStyle=outfit;ctx.fillRect(-22,-7,44,14);
    // Head
    ctx.fillStyle=skin;ctx.beginPath();ctx.arc(25,0,9,0,Math.PI*2);ctx.fill();
    // Cap
    ctx.fillStyle=outfit;ctx.beginPath();ctx.arc(25,-2,9,Math.PI,0);ctx.fill();
    // Goggles
    ctx.fillStyle='#333';ctx.fillRect(18,-2,14,4);ctx.fillStyle='#87CEEB';ctx.fillRect(20,-1,4,2);ctx.fillRect(26,-1,4,2);
    // Arms
    const a=(t*9)%1;ctx.fillStyle=skin;
    ctx.save();ctx.translate(-12,0);ctx.rotate(a*Math.PI*2);ctx.fillRect(-3,-18,6,20);ctx.restore();
    ctx.save();ctx.translate(8,0);ctx.rotate((a+0.5)*Math.PI*2);ctx.fillRect(-3,-18,6,20);ctx.restore();
    // Splash
    ctx.fillStyle='rgba(255,255,255,0.5)';for(let i=0;i<4;i++){ctx.beginPath();ctx.arc(-26-i*7+Math.sin(t*12+i)*3,Math.sin(t*16+i*2)*7,2.5,0,Math.PI*2);ctx.fill();}
    ctx.restore();
}

function endRace(time){
    running=false;cancelAnimationFrame(anim);
    const all=[{name:'YOU',time,you:true},...cpus.map(c=>({name:c.name,time:c.fin?c.time:time+5,you:false}))].sort((a,b)=>a.time-b.time);
    const rank=all.findIndex(r=>r.you)+1;
    if(!isOnline)saveScore(curDist,time);
    if(isTourn){tScores[tIdx]=time;tIdx++;updateTournUI();}
    document.getElementById('rIcon').textContent=rank===1?'ü•á':rank===2?'ü•à':rank===3?'ü•â':'üèÅ';
    document.getElementById('rTtl').textContent=rank===1?'GOLD MEDAL!':rank<=3?'PODIUM!':'FINISHED';
    document.getElementById('rScore').textContent=time.toFixed(2)+'s';
    document.getElementById('rRanks').innerHTML=all.map((r,i)=>`<div class="rank ${i===0?'gold':''} ${r.you?'you':''}"><span>${['ü•á','ü•à','ü•â'][i]||(i+1)+'.'} ${r.name}</span><span>${r.time.toFixed(2)}s</span></div>`).join('');
    show('s7');
}

function retry(){if(isTourn){const ev=TEVENTS[tIdx>0?tIdx-1:0];curGame=ev.g;curDist=ev.d;}startRace();}

function showLB(dist){
    document.getElementById('lbDist').innerHTML=DISTS.map(d=>`<div class="opt ${d.m===dist?'sel':''}" data-d="${d.m}">${d.m}M</div>`).join('');
    document.querySelectorAll('#lbDist .opt').forEach(el=>{tap(el,()=>showLB(parseInt(el.dataset.d)));});
    const sc=load('sc_sprint_'+dist)||[];
    document.getElementById('lbList').innerHTML=sc.length===0?'<div style="text-align:center;padding:25px;color:#555;"><div style="font-size:1.8rem;">üì≠</div><div style="font-size:0.45rem;margin-top:10px;">NO RECORDS</div></div>':sc.map((s,i)=>`<div class="rank ${i===0?'gold':''} ${s.n===player.name?'you':''}"><span>${['ü•á','ü•à','ü•â'][i]||(i+1)+'.'}</span><span style="flex:1;margin-left:10px;">${s.n}</span><span style="color:#f1c40f;">${s.t.toFixed(2)}s</span></div>`).join('');
}
</script>
</body>
</html>
